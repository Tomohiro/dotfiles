" for Vimperator 3

" これらの機能で新規タブを開いた際はアクティブにする
set activate=homepage,tabopen,paste

" :[tab]open コマンドで補完する候補と順番
set complete=sbhS

" ブラウザタイトルの変更
"set titlestring="Firefox"

" GUI オプション
set gui=none,tabs

" visualbell有効
set visualbell

" onload 時にテキストボックス等にオートフォーカスしないようにする
set focuscontent

" ヒントモードでアルファベットを使う
set hintchars=ifjklasdweuocvbnm

" C-r でブラウザ再起動
map <C-r> :restart<CR>

" 設定ファイルを再読み込み
map ,s :so ~/.vimperatorrc<CR>
map ,S :mapc<CR>:cmapc<CR>:imapc<CR>:so ~/.vimperatorrc<CR>

" バーの表示切り替え
map <C-0> :set gui=all<CR>
map <C-1> :set gui=none,tabs<CR>
map <C-2> :set gui=none,tabs,bookmarks<CR>
map <C-3> :set gui=none,tabs,navigation<CR>
map <C-4> :set gui=none,tabs,navigation,bookmarks<CR>

" 上のディレクトリに移動
map <BS> gu
map <C-BS> gU

" ]]/[[ で次/前のページに移動
set nextpattern+=次を表示,次のページ,\b次.*,→\b
set previouspattern+=前を表示,前のページ,\b前.*,\b←

" j/k でのスクロール幅を1行から3行に変更
map j 3<C-e>
map k 3<C-y>

" J/K をC-d/u互換に
map J <C-d>
map K <C-u>

" h/l でタブ移動
map h <C-p><Esc>
map l <C-n><Esc>

" C-h/l でタブ位置変更
map <C-h> :tabmove! -1<CR>
map <C-l> :tabmove! +1<CR>

" SKK のため C-j を無効化
cmap <C-j> <Nop>
imap <C-j> <Nop>
map  <C-j> <Nop>

" ソース閲覧
map V gf

" ex modeでUp/DownをTab/S-Tab互換に
cmap <Down> <Tab>
cmap <Up> <S-Tab>

" ! でページのCSSをon/off
map ! :set invum<CR>

" コマンドライン、テキストエリア内では<C-v>で貼り付け
cnoremap <C-c> <C-c>
inoremap <C-c> <C-c>

" ページのアクセスキーを無効化 
javascript <<JS
  liberator.modules.options.setPref('ui.key.generalAccessKey', 0);
JS

javascript <<JS
let statusLine = document.getElementById("liberator-statusline");
let bottomBar  = document.getElementById("liberator-bottombar");

// ステータスラインに戻る/進むを表示
if(!document.getElementById("history-indicators")) {
    let xml = <hbox id="history-indicators" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
        <label value="&lt;" id="back-indicator" class="history-indicator">
        <observes element={document.getElementById("back-button").command} attribute="disabled" />
        </label>
        <label value="&gt;" id="forward-indicator" class="history-indicator">
        <observes element={document.getElementById("forward-button").command} attribute="disabled" />
        </label>
        </hbox>;

    statusLine.appendChild(document.adoptNode(new DOMParser().parseFromString(xml.toXMLString(), "application/xml").documentElement, true));
}

// ステータスラインの横にステータスバーを移動
let (statusBar = document.getElementById("status-bar")) {
    statusBar.style.maxHeight = "20px";
    bottomBar.appendChild(statusBar);
}

// ステータスラインにfaviconを移動
let (favicon = document.getElementById("page-proxy-stack")) {
    favicon.style.maxWidth = favicon.style.maxHeight = "20px";
    statusLine.insertBefore(favicon, statusLine.firstChild);
}
JS

style -name history-indicators chrome://browser/content/browser.xul <<CSS
#history-indicators {
    padding: 0 ! important;
}
.history-indicator {
margin: 0 1px ! important;
color: WindowText;
}
.history-indicator[disabled="true"] {
    //visibility: hidden;
}
CSS


" Plugin Settings
" ==================================================

" copy.js
map cp :copy<Space>
javascript <<JS
liberator.globalVariables.copy_templates = [
  { label: 'Title and URL',  value: '%TITLE%\n%URL%' },
  { label: 'Markdown',       value: '[%TITLE%](%URL%)' },
];
JS

" feedSomeKeys_3.js
command! -nargs=+ lazy autocmd VimperatorEnter .* <args>
lazy fmaps -u='mail\.google\.com/mail' c / j k n p o u e x s r a # [ ] ? gi gs gt gd ga gc
lazy fmaps -u='mail\.google\.com/mail/.*/[0-9a-f]+$' c / j,n k,p n,j p,k o u e x s r a # [ ] ? gi gs gt gd ga gc
lazy fmaps -u='(fastladder|livedoor)\.com/reader' j k s a p o v c i,p <Space> <S-Space> z b < > q w e,g g
lazy fmaps -u='fastladder\.com/reader/' i,Tj
lazy fmaps -u='fastladder\.com/reader/' e,Tj

" http://vimperator.g.hatena.ne.jp/nokturnalmortum/20110406/1302077288
fmap -modes=i -events=keydown,keypress <C-p> <Up>
fmap -modes=i -events=keydown,keypress <C-n> <Down>

" refcontrol.js
let g:refcontrol_enabled = "true"
javascript <<EOM
liberator.globalVariables.refcontrol = {
    '@DEFAULT'          : '@NORMAL',
    'fc2.com'           : '@FORGE',
    'blogs.yahoo.co.jp' : '@FORGE',
    'blog.goo.ne.jp'    : '@FORGE',
    'ameblo.jp'         : '@FORGE',
};
EOM

" 読み込んだ事を出力
echo ".vimperatorrc sourced"
