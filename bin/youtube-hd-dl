#!/bin/sh
#
# Name:
#    YouTube HD Downloader
# Usage:
#    $ youtube-hd-dl [URL]
#
# References:
#    ffmpeg options - http://qiita.com/kitar/items/59f80bba2ca997e0f5e6
#


set -e

function run() {
  local command=$1
  echo "==> Executing: ${command}"
  eval $command
}


echo "Initializing: Collect video metadata..."
url="$@"
title=$(youtube-dl -e $url)
id="$(echo $url | cut -d '=' -f 2)"
filename="${title}-${id}"


echo "Downloading: $title from YouTube..."
sound=141
video=$(youtube-dl -F $url | grep 1080 | grep mp4 | tail -n 1 | cut -d ' ' -f 1)
run "youtube-dl -f $sound,$video $url"


echo "Converting: unite audio and video..."
option='-movflags faststart -vcodec copy -acodec copy'
output="${HOME}/Downloads/${title}.mp4"
run "ffmpeg -i '${filename}.mp4' -i '${filename}.m4a' $option '$output'"

echo "Cleanup: delete sources..."
run "mv '${filename}.m4a' ~/.Trash/"
run "mv '${filename}.mp4' ~/.Trash/"
