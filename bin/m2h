#!/usr/bin/env ruby

require 'rubygems'
require 'nokogiri'

CONVERTER = 'Markdown.pl'
SUFFIX = '.mkdn'

class Markdown2HTML
  def initialize
    @mkdn_path = nil || Dir.pwd
    @html_path = nil || Dir.pwd
    @css_path  = '/'
  end

  def run
    @html_template = create_html_template

    output_html(convert_html_body)
  end

  def create_html_template
    <<-HTML 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">
    <head>
        <meta name="viewport" content="width=320" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta http-equiv="Content-Script-Type" content="text/javascript" />
        <meta http-equiv="Content-Style-Type" content="text/css" />
        <link rel="stylesheet" type="text/css" media="screen, print" href="#{@css_path}styles/reset-min.css" />
        <link rel="stylesheet" type="text/css" media="screen, print" href="#{@css_path}styles/fonts-min.css" />
        <link rel="stylesheet" type="text/css" media="screen and (min-device-width: 481px), print" href="#{@css_path}styles/m2h.css" />
        <link rel="stylesheet" type="text/css" media="only screen and (max-device-width: 480px)" href="#{@css_path}styles/iphone.css" />
        <!--[if IE]><link rel="stylesheet" type="text/css" media="screen, projection" href="#{@css_path}styles/m2h.css" /><![endif]-->
        <script type="text/javascript" src="scripts/google-analytics.js"></script>
        <script type="text/javascript" src="scripts/disqus.js"></script>
        <title>%TITLE%</title>
    </head>
    <body>
        <div id="container">

            <!-- Auto generated start -->
            %CONTENTS%
            <!-- Auto generated end -->

            <div id="menu">
                <ul>
                    <li><a href="./index.html">トップ</a></li>
                    <li><a href="http://tomohiro.github.com">visit Tomohiro.GitHub</a></li>
                </ul>
            </div>
            <div id="footer">
                <p>Copyright &#169; #{Date.today.year} <a href="http://tomohiro.github.com">Tomohiro.GitHub</a> All rights reserved.</p>
                <p>Generated by <a href="http://gist.github.com/276064" title="m2 - Markdown2HTML">m2 - Markdown2HTML</a></p>
            </div>
        </div>
    </body>
</html>
    HTML
  end

  def create_comments_template
    <<-DISQUS
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://tomohiro.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=tomohiro">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    DISQUS
  end

  def convert_html_body
    body_list = {}

    Dir.glob("#{@mkdn_path}/*#{SUFFIX}").each do |file_name|
      body_list[file_name] = `#{CONVERTER} #{file_name}`
    end

    body_list
  end

  def output_html(body_list)
    comments = create_comments_template
    body_list.each do |file_name, body|
      html_name = file_name.gsub(SUFFIX, '.html')
      title = [(Nokogiri::HTML(body)/'h2').text, (Nokogiri::HTML(body)/'h1').text].join(' - ')
      content = @html_template.gsub('%TITLE%', title)
      content.gsub!('%CONTENTS%', body)
      content.gsub!('%COMMENTS%', comments)

      path = "../#{File.basename(html_name)}"
      File.open(path, 'w') do |f|
        f.write content
      end
    end
  end
end

Markdown2HTML.new.run
