#!/usr/bin/env ruby

module MozRepl
  module Telnet
    require 'net/telnet'
    def self.open(host = nil, port = nil)
      @host = host || 'localhost'
      @port = port || 4242
      @telnet = Net::Telnet.new({'Host' => @host, 'Port' => @port })
    end

    def self.close
      @telnet.close
    end

    def self.cmd(js)
      @telnet.cmd(js)
    end
  end

  module JS
    def self.reload_current_tab
      js = <<-JS
      x = content.window.pageXOffset;
      y = content.window.pageYOffset;
      BrowserReload();
      content.window.scrollTo(x, y);
      JS
      Telnet.cmd(js)
    end

    def self.reload_target_tab(query)
      js = <<-JS
      var num = gBrowser.browsers.length;
      for (var i = 0; i < num; i++) {
          var buf = gBrowser.getBrowserAtIndex(i);
          try {
              if (buf.currentURI.spec.match(/#{query}/) || buf.contentTitle.match(/#{query}/)) {
                  buf.reload();
              }
          } catch(e) {
              Components.utils.reportError(e);
          }
      }
      JS
      Telnet.cmd(js)
    end

    def self.open(uri)
      Telnet.cmd("gBrowser.selectedTab = gBrowser.addTab('#{uri}')")
    end
  end
end


Version = '0.0.0'
class CLIFox
  require 'optparse'
  include MozRepl

  def initialize
    @host = nil
    @port = nil
  end

  def self.run
    new.main
  end

  def main
    begin
      opts = {}
      ARGV.options do |o|
        o.on('-h', '--host [host]') { |v| @host = v }
        o.on('-p', '--port [port]') { |v| @port = v }
        o.on('-r', '--reload [page title or uri]') { |v| repl_eval { reload(v) } }
        o.on('-o', '--open URI') { |v| repl_eval { JS.open(v) } }
        o.parse!
      end
    rescue => e
      puts e.inspect
      exit 1
    end
  end

  def repl_eval
    repl = Telnet.open(@host, @port)
    yield
    repl.close
  end

  def reload(query = nil)
    if query
      JS.reload_target_tab(query)
    else
      JS.reload_current_tab
    end
  end
end

if __FILE__ == $0
  CLIFox.run
end
