#!/bin/sh

# sshfs-svn
#
# sshfs でリモート先の Subvresion のワーキングディレクトリを
# 手元のマシンにマウントしている場合，
# リモート先の svn コマンドを手元で実行するためのコマンド
#
# インストール
# -----------
#
# 1. ダウンロードして実行権限を付与
#
#     $ curl -o sshfs-svn http://debeso.es.occ.co.jp/api/v1/snippets/27
#     $ chmod +x sshfs-svn
#
# 2. パスの通っているディレクトリに配置
#
#     $ mv sshfs-svn $HOME/bin/
#
#
# 使い方
# -----
#
# 1. sshfs のマウント先ディレクトリを作る(ディレクトリ名は FQDN)
#
#      $ mkdir -p $HOME/mnt/example.es.occ.co.jp
#
# 2. sshfs でマウントする
#
#      $ sshfs example.es.occ.co.jp: $HOME/mnt/example.es.occ.co.jp
#
# 3. Subversion のワーキングディレクトリへ移動
#
#      $ cd $HOME/mnt/example.es.occ.co.jp/my-work-dir
#      $ sshfs-svn version
#      Remote svn client at wm4-dev.es.occ.co.jp
#      svn, バージョン 1.6.11 (r934486)


set -e

    get_remote_host() {
      local path=$1
      for dir in $(ls $HOME/mnt); do
        if echo $path | grep $dir >/dev/null ; then
          echo "$dir"
          return 0
        fi
      done

      echo "No such mounted server: $path"
      return 1
    }

    get_working_dir() {
      local host=$1
      local path=$2
      local dir=$(echo $path | sed -e "s:$(echo $HOME | sed -e 's:/:\\/:g')/mnt/$(echo $host | sed -e 's/\./\\./g')/::")
      echo $dir
      return 0
    }



host=$(get_remote_host $(pwd))
if [ $? = 0 ]; then 
  echo "Remote svn client at $host"
  dir=$(get_working_dir $host $(pwd))
  echo "ssh $host \"cd $dir && svn $@\""
  ssh $host "cd $dir && svn $@"
  exit 0
else
  echo $host
  exit $?
fi
