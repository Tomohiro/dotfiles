#!/bin/sh

set -e

# Get coreos-xhyve path https://github.com/Tomohiro/dotfiles/bundle/coreos-xhyve
readonly ROOT_DIR=$(cd $(readlink $(cd $(dirname $0) && pwd))/.. && pwd)/bundle/coreos-xhyve


# Usage shows commands description
usage() {
  echo "Usage: $0 COMMAND"
  echo
  echo '  init               # Create configuration to ~/.config/coreos-xhyve.conf'
  echo '  fetch              # Fetch CoreOS images from specified channel (default: alpha)'
  echo '  run                # Run coreos-xhyve'
  echo '  help, --help, -h   # Run coreos-xhyve'
}

# Init creates coreos-xhyve configuration
init() {
  cat << EOF > $HOME/.config/coreos-xhyve.conf
# See https://github.com/coreos/coreos-xhyve#customize
MEMORY=2048
CHANNEL=alpha
ROOT_HDD=/Users/tomohiro/Workspaces/xhyve.img
EOF
  echo "Saved configuration to $HOME/.config/coreos-xhyve.conf"
}

command=$1
case $command in
  'init')
    init
    ;;
  'run')
    pushd ${ROOT_DIR}
      sudo ./coreos-xhyve-run -f $HOME/.config/coreos-xhyve.conf
    popd
    ;;
  'fetch')
    pushd ${ROOT_DIR}
      ./coreos-xhyve-fetch
    popd
    ;;
  'help' | '--help' | '-h' | '')
    usage
    ;;
  *)
    echo "Sorry, ${command} is unknown command."
    usage
    exit 1
    ;;
esac
